---
title: "GitHub Actions ã§ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ:)"
emoji: "ğŸ¶"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["42Tokyo", "githubactions", "leak", "valgrind", "test"]
published: false
---

:::message
ã“ã‚“ã«ã¡ã¯ï¼Œ[42tokyo Advent Calendar 2021](https://qiita.com/advent-calendar/2021/42tokyo) ã® 4 æ—¥ç›®ã‚’æ‹…å½“ã™ã‚‹ã€åœ¨æ ¡ç”Ÿã® [tayamamo](https://profile.intra.42.fr/users/tayamamo) ã§ã™ï¼
:::

:::message
æ˜æ—¥ã¯ï¼Œnafuka ã•ã‚“ãŒã€STLã‚³ãƒ³ãƒ†ãƒŠã®è©± or 42Tokyoã§1å¹´åŠå­¦ç”Ÿç”Ÿæ´»ã€ã«ã¤ã„ã¦æ›¸ã„ã¦ãã‚Œã‚‹äºˆå®šã§ã™ã®ã§ï¼Œãã¡ã‚‰ã®è¨˜äº‹ã‚‚ãŠæ¥½ã—ã¿ã«ï¼
:::


# è¦ç´„
Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ Makefile ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§è¡Œãªã£ã¦ã„ãŸ [Valgrind](https://valgrind.org/) ã¨ [Sanitizers](https://github.com/google/sanitizers) ã‚’ç”¨ã„ãŸãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’ï¼ŒGithub Actions ã‚’ç”¨ã„ã¦ï¼ŒGitHub ä¸Šã§ã‚‚è¡Œãˆã‚‹ã‚ˆã†ã«ã—ãŸï¼ã“ã®ã“ã¨ã«ã‚ˆã‚Šï¼Œãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ã«ãªã‚Šï¼Œé–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ãŒå‘ä¸Šã—ãŸï¼


# åºè«–
42Tokyo ã§ã¯ï¼Œæ—¥ã€…ãƒ”ã‚¢ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã¨èª²é¡Œè§£æ±ºå‹å­¦ç¿’ã‚’é€šã—ã¦å­¦ç¿’ã«åŠ±ã‚“ã§ã„ã¾ã™ï¼ä½•ã‹ã‚’æ•™ãˆã¦ãã‚Œã‚‹æ•™å¸«ã‚„ãƒ¡ãƒ³ã‚¿ãƒ¼ãŒã„ãªã„ã®ã§ï¼Œè‡ªåˆ†ãŸã¡ã§èª²é¡Œã‚’ç†è§£ã—ï¼Œå•é¡Œç‚¹ã‚’è¦‹ã¤ã‘ï¼Œè§£æ±ºã—ï¼Œè©•ä¾¡ã—ã¦ã„ã¾ã™ï¼è©•ä¾¡ã‚’è¡Œã†ã¨ãã«ã¯ï¼Œè©•ä¾¡é …ç›®ã«æ²¿ã£ã¦ï¼Œç›¸æ‰‹ã®èª²é¡Œã‚’è©•ä¾¡ã—ã¾ã™ï¼ãã®éš›ã«ã¯ï¼Œè‡ªåˆ†ãŒä»Šã¾ã§å¾—ãŸçŸ¥è¦‹ã‚’ç”Ÿã‹ã—ï¼Œç›¸æ‰‹ã®ã‚³ãƒ¼ãƒ‰ã®ãƒŸã‚¹ãƒ†ã‚¤ã‚¯ã‚’è¦‹ã¤ã‘ãŸã‚Šï¼Œã‚³ãƒ¼ãƒ‰ãŒã‚ˆã‚Šè‰¯ããªã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ãŸã‚Šï¼Œã•ã‚ŒãŸã‚Šï¼Œè­°è«–ã—ãŸã‚Šï¼Œèª²é¡Œã§å•ã‚ã‚Œã¦ã„ã‚‹å†…å®¹ã‚’ãã¡ã‚“ã¨ç†è§£ã—ï¼Œè‡ªåˆ†ã§å®Ÿè£…ã§ãã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ãŸã‚Šã—ã¾ã™ï¼ã“ã“ã§ï¼Œè©•ä¾¡è€…ãŒç™ºè¦‹ã—ãŸãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§ãã‚‹ï¼Œå®Ÿè£…è€…ãŒ**æ„å›³ã—ã¦ã„ãªã„æŒ™å‹•**ï¼Œ**ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼**ï¼Œ**ãƒªãƒ¼ã‚¯**ï¼Œ**ã‚»ã‚°ãƒ•ã‚©**ã¯çµ¶å¯¾ã«è¨±å®¹ã•ã‚Œã¾ã›ã‚“ï¼ã“ã‚ŒãŒæ›²è€…ã§ï¼Œæ™‚é–“ãŒçµŒã£ã¦ãã‚‹ã¨ 42Tokyo å†…ã§èª²é¡Œã«å¯¾ã™ã‚‹çŸ¥è¦‹ãŒæºœã¾ã£ã¦ã„ãï¼Œã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ç›®ãŒã©ã‚“ã©ã‚“é«˜åº¦ã«ãªã‚Šï¼Œèª²é¡Œã‚’ã‚µã‚¯ã‚»ã‚¹ã•ã›ã‚‹ã“ã¨ãŒé›£ã—ããªã£ã¦ã„ãã¾ã™ï¼çŸ¥è­˜ãŒæµ…ã„ã¾ã¾ã§å®Ÿè£…ã‚’ã—ã¦ã„ã‚‹ã¨ï¼Œç›´ãã«ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ãŒï¼Œã‚‚ã†çŸ¥ã‚Šå¾—ãŸã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¼ã‚Œç™ºè¦‹ãªã©ã¯ç…©ã‚ã—ããªã£ã¦ãã¾ã™ï¼
ãã“ã§ï¼Œãƒ­ãƒ¼ã‚«ãƒ«ã§ Docker ã‚³ãƒ³ãƒ†ãƒŠã¨ Makefile ã‚’ç”¨ã„ã¦è¡Œãªã£ã¦ã„ãŸ Valgrind ã¨ Sanitizer ã®ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’ GitHub Actions ã‚’ç”¨ã„ã¦ï¼Œãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã‚‰è‡ªå‹•ã§èµ°ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸï¼
42 ã§ã¯ï¼Œ[Build your own X](https://github.com/danistefanovic/build-your-own-x) ã®ç²¾ç¥ã§ï¼Œè»Šè¼ªã®å†ç™ºæ˜ã‚’ã©ã‚“ã©ã‚“è¡Œãªã£ã¦ã„ã‚‹ã®ã§ï¼Œè‡ªåˆ†ã§ãƒªãƒ¼ã‚¯ãƒã‚§ãƒƒã‚«ãƒ¼[^1]ãªã©ã‚’å®Ÿè£…ã§ããŸã‚‰è‰¯ã‹ã£ãŸã®ã§ã™ãŒï¼Œä»Šå›ã¯å·¨äººã®è‚©ã«ãŸãã•ã‚“ä¹—ã‚‰ã›ã¦ã‚‚ã‚‰ã„ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã®ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã—ãŸï¼

[^1]:ä¾‹: [leak_check_xmalloc](https://github.com/sickl8/leak_check_xmalloc), [wraloc](https://github.com/lorenuars19/wraloc), [42_memleak_check](https://github.com/IamTheKaaZZ/42_memleak_check), [ft_mallocator](https://github.com/tmatis/ft_mallocator)


# ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
Docker ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ Makefile ã«æ›¸ã‹ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ï¼Œãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’è¡Œãªã£ã¦ã„ã¾ã™ï¼

## Valgrind ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
1. Valgrind ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ Dockerfile ã‚’æ›¸ãï¼
    ```dockerfile:Dockerfile
    FROM ubuntu:20.04

    RUN apt-get update && \
        apt-get upgrade -y && \
        apt-get install -y build-essential valgrind && \
        rm -fr /var/lib/apt/lists/*

    WORKDIR /code

    CMD /bin/bash
    ```
1. `make valgrind` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ Valgrind ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã« Makefile ã‚’æ›¸ãï¼
    ```makefile:Makefile
    .PHONY: valgrind
    valgrind: re
        valgrind --leak-check=full --show-leak-kinds=all --track-fds=yes ./$(NAME)
    ```
1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ï¼Œã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ Valgrind ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ï¼
    ```shell:Terminal
    docker run -it --rm -v $PWD:/code solareenlo/42docker make valgrind
    ```

## Sanitizer ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
1. gcc ã¾ãŸã¯ clang ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ Dockerfile ã‚’æ›¸ãï¼
    ```dockerfile:Dockerfile
    FROM ubuntu:20.04

    RUN apt-get update && \
        apt-get upgrade -y && \
        apt-get install -y build-essential clang && \
        rm -fr /var/lib/apt/lists/*

    WORKDIR /code

    CMD /bin/bash
    ```
1. `make leak`, `make address`, `make thread`, `make memory` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã‚Œãã‚Œã® Sanitizer ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã« Makefile ã‚’æ›¸ãï¼
    ```makefile:Makefile
    CFLAGS    := -Wall -Wextra -Werror -std=c++98 --pedantic

    .PHONY: leak
    leak: CFLAGS += -g -fsanitize=leak
    leak: test

    .PHONY: address
    address: CFLAGS += -g -fsanitize=address
    address: test

    .PHONY: thread
    thread: CFLAGS += -g -fsanitize=thread
    thread: test

    .PHONY: memory
    memory: CFLAGS += -g -fsanitize=memory
    memory: test

    .PHONY: test
    test: re
        ./$(NAME)
    ```
1. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ï¼Œã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ Sanitizer ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ï¼
    ```shell:Terminal
    docker run -it --rm -v $PWD:/code solareenlo/42docker make leak
    docker run -it --rm -v $PWD:/code solareenlo/42docker make address
    docker run -it --rm -v $PWD:/code solareenlo/42docker make thread
    docker run -it --rm -v $PWD:/code solareenlo/42docker make memory
    ```

# ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã®ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
Github Actions ã‚’ç”¨ã„ã¦åŒæ§˜ã®ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½¿ç”¨ã—ã¦ã„ãŸ Makefile ã¨åŒæ§˜ã®ã‚‚ã®ã‚’ä½¿ã£ã¦ï¼

## Valgrind ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
##### CI ç’°å¢ƒã«ç›´æ¥ Valgrind ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹æ–¹æ³•
1. CI ç’°å¢ƒã« Valgrind ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ GitHub Action ã‚’æ›¸ãï¼
    ```yml:.github/workflows/valgrind.yml
    name: Valgrind
    on: [ push, pull_request ]

    jobs:
      Valgrind:
        runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: install valgrind
      run: |
        sudo apt update
        sudo apt install -y valgrind
      - name: Run Valgrind
      run: make valgrind
    ```

##### Docker containe action ã‚’ç”¨ã„ã‚‹æ–¹æ³•
1. Github Actions ç”¨ã® Valgrind ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ [Dockerfile](https://github.com/solareenlo/42valgrind-docker/blob/ab94cd3ece50e87aec0a8a1b287f3eab3bca40bf/Dockerfile#L10) ã‚’æ›¸ãï¼
1. ä¸Šè¨˜ã‚’å®Ÿè¡Œã™ã‚‹ [Docker container action](https://github.com/solareenlo/42valgrind-action/blob/70a2e79c6cc27ad850a962827130d82e4635d00b/action.yml#L16) ã‚’æ›¸ãï¼
1. ä¸Šè¨˜ã‚’å®Ÿè¡Œã™ã‚‹ [GitHub action](https://github.com/solareenlo/42Old-CPP_Module_07/blob/2a3be991c06e3b457b7cca689863b77d654742cf/.github/workflows/valgrind.yml#L18) ã‚’æ›¸ãï¼


## Sanitizer ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
1. CI ç’°å¢ƒã« Sanitizers ã‚’å®Ÿè¡Œã™ã‚‹ GitHub Action ã‚’æ›¸ãï¼
    ```yml:.github/workflows/sanitizers.yml
    name: Sanitizers
    on: [ push, pull_request ]

    jobs:
      Sanitizers:
        runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Sanitizers
      run: |
        make leak
        make address
        make thread
        make memory
    ```

ã“ã‚Œã§ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨ï¼ŒValgrind, Sanitizers ã®ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼


# çµè«–
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã‚‚ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šï¼Œå¤§å¤‰ä¾¿åˆ©ã ãŒï¼Œè©•ä¾¡ç’°å¢ƒã¨ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ã«è‹¥å¹²ã®å·®ç•°ãŒã‚ã‚‹ã®ã§æ°—ã‚’ä»˜ã‘ã‚‹ï¼
- [reviewdog](https://github.com/reviewdog/reviewdog) ã§ãƒªãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ãŒè‡ªå‹•ã§ãƒ—ãƒ«ãƒªã‚¯ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼
- ä»–ã®ãƒ†ã‚¹ãƒˆã‚‚ã©ã‚“ã©ã‚“è¿½åŠ ã™ã‚‹ï¼
- ã“ã®æ„Ÿã˜ã§ã„ã‚ã‚“ãªã“ã¨ã‚’è‡ªå‹•åŒ–ã™ã‚‹ï¼
- ã‚‚ã£ã¨æ—©ãã«ã‚„ã£ã¦ãŠã‘ã°è‰¯ã‹ã£ãŸã§ã™ orm


# å‚è€ƒ
- [42valgrind-action](https://github.com/solareenlo/42valgrind-action)
- [42valgrind-docker](https://github.com/solareenlo/42valgrind-docker)
- [42docker](https://github.com/solareenlo/42docker)


# è¬è¾
ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ï¼Œã„ã‚ã‚“ãªä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¦ï¼Œæœ¬å½“ã«æ„Ÿè¬ã§ã™ï¼
42Tokyo ã§ã¯ï¼Œè‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§ã„ã‚ã‚“ãªã“ã¨ã‚’è‡ªç”±ã«å‹‰å¼·ã§ãã¦ï¼Œæœ¬å½“ã«æ„Ÿè¬ã§ã™ï¼
42Tokyo ã«é–¢ã‚ã‚‹çš†ã•ã‚“ã«ã¯ï¼Œã„ã‚ã‚“ãªã“ã¨ã‚’å„ªã—ãæ•™ãˆã¦ãã ã•ã‚Šï¼Œæœ¬å½“ã«æ„Ÿè¬ã§ã™ï¼
